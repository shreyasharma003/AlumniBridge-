<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Alumni Bridge</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f5f5;
        display: flex;
        height: 100vh;
      }

      .container {
        display: flex;
        width: 100%;
        height: 100vh;
      }

      .sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sidebar-header h2 {
        font-size: 18px;
        color: #333;
      }

      .new-chat-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .new-chat-btn:hover {
        background: #5568d3;
      }

      .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
      }

      .conversation-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .conversation-item:hover {
        background: #f9f9f9;
      }

      .conversation-item.active {
        background: #e8ecff;
        border-left: 4px solid #667eea;
        padding-left: 16px;
      }

      .conversation-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
      }

      .conversation-preview {
        font-size: 13px;
        color: #999;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
      }

      .chat-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f9f9f9;
      }

      .chat-header h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 5px;
      }

      .chat-header-status {
        font-size: 12px;
        color: #999;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: white;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
      }

      .message.own {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 60%;
        padding: 12px 16px;
        border-radius: 10px;
        word-wrap: break-word;
      }

      .message.other .message-bubble {
        background: #f0f0f0;
        color: #333;
      }

      .message.own .message-bubble {
        background: #667eea;
        color: white;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .message-input-area {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        background: white;
      }

      .message-input-area input {
        flex: 1;
        border: 1px solid #e0e0e0;
        padding: 12px 15px;
        border-radius: 5px;
        font-size: 14px;
        font-family: inherit;
      }

      .message-input-area input:focus {
        outline: none;
        border-color: #667eea;
      }

      .message-send-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      .message-send-btn:hover {
        background: #5568d3;
      }

      .no-conversations {
        text-align: center;
        padding: 20px;
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>Messages</h2>
          <button class="new-chat-btn" onclick="startNewChat()">+ New</button>
        </div>
        <div class="conversations-list" id="conversationsList">
          <div class="no-conversations">
            <p>No conversations yet</p>
          </div>
        </div>
      </div>

      <div class="chat-area">
        <div id="chatContent" class="empty-state">
          <div class="empty-state-icon">ðŸ’¬</div>
          <p>Select a conversation to start chatting</p>
        </div>

        <div
          id="chatWindow"
          style="display: none; flex: 1; display: flex; flex-direction: column"
        >
          <div class="chat-header">
            <h3 id="chatPartnerName">Chat Name</h3>
            <div class="chat-header-status">Online</div>
          </div>

          <div class="messages-container" id="messagesContainer"></div>

          <div class="message-input-area">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message..."
            />
            <button class="message-send-btn" onclick="sendMessage()">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
      let currentConversation = null;
      let conversations = [];
      let currentUserId = null;

      document.addEventListener("DOMContentLoaded", function () {
        checkAuth();
        loadUserInfo();
        loadConversations();
      });

      function checkAuth() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
        }
      }

      function loadUserInfo() {
        currentUserId = localStorage.getItem("userId");
      }

      async function loadConversations() {
        try {
          const messages = await apiCall("/messages", { method: "GET" });
          console.log("Messages:", messages);

          const conversationMap = {};

          if (Array.isArray(messages)) {
            messages.forEach((conv) => {
              conversationMap[conv.userId] = {
                userId: conv.userId,
                userName: conv.userName,
                lastMessage: conv.lastMessage,
              };
            });
          }

          conversations = Object.values(conversationMap);
          renderConversations();
        } catch (error) {
          console.error("Failed to load conversations:", error);
        }
      }

      function renderConversations() {
        const conversationsList = document.getElementById("conversationsList");

        if (conversations.length === 0) {
          conversationsList.innerHTML =
            '<div class="no-conversations"><p>No conversations yet</p></div>';
          return;
        }

        conversationsList.innerHTML = conversations
          .map(
            (conv) => `
                    <div class="conversation-item ${
                      currentConversation?.userId === conv.userId
                        ? "active"
                        : ""
                    }" 
                         onclick="selectConversation(${conv.userId}, '${
              conv.userName
            }')">
                        <div class="conversation-name">${conv.userName}</div>
                        <div class="conversation-preview">${
                          conv.lastMessage
                        }</div>
                    </div>
                `
          )
          .join("");
      }

      function selectConversation(userId, userName) {
        currentConversation = { userId, userName };
        document.getElementById("chatContent").style.display = "none";
        document.getElementById("chatWindow").style.display = "flex";
        document.getElementById("chatPartnerName").textContent = userName;
        renderConversations();
        loadMessages(userId);
      }

      async function loadMessages(userId) {
        try {
          const messages = await apiCall(`/messages/${userId}`, {
            method: "GET",
          });
          renderMessages(messages || []);
        } catch (error) {
          console.error("Failed to load messages:", error);
        }
      }

      function renderMessages(messages) {
        const container = document.getElementById("messagesContainer");

        if (!Array.isArray(messages) || messages.length === 0) {
          container.innerHTML =
            '<p style="text-align: center; color: #999;">No messages yet</p>';
          return;
        }

        container.innerHTML = messages
          .map(
            (msg) => `
                    <div class="message ${
                      msg.senderId === currentUserId ? "own" : "other"
                    }">
                        <div class="message-bubble">${msg.content}</div>
                    </div>
                `
          )
          .join("");

        container.scrollTop = container.scrollHeight;
      }

      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message || !currentConversation) return;

        try {
          await apiCall("/messages", {
            method: "POST",
            body: JSON.stringify({
              recipientId: currentConversation.userId,
              content: message,
            }),
          });

          input.value = "";
          loadMessages(currentConversation.userId);
        } catch (error) {
          console.error("Failed to send message:", error);
          alert("Failed to send message");
        }
      }

      function startNewChat() {
        alert("New chat feature coming soon!");
      }
    </script>
  </body>
</html>
